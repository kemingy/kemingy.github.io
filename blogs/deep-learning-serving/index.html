<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>
Cyanide - Deep Learning Serving Framework
</title>

    <link rel="stylesheet" href="https://blog.mapotofu.org/style.css">

    
    <link rel="alternate" type="application/atom+xml" title="RSS"
        href="https://blog.mapotofu.org/atom.xml">
    

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
        integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
        integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
        integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {delimiters:[
        {left: '$$', right: '$$', display: true},
        {left: '\\[', right: '\\]', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false}]});"></script>
    

    
<meta name="google-site-verification" content="OEmuX--u8eJZ_sTIR-hUG85I8snl3z0En6PspWN-OJQ" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ–‹</text></svg>">

</head>

<body>
    <div class="container">
        <div class="mobile-navbar">
            <div class="mobile-header">
                <a href="/" class="title">Cyanide</a>
            </div>
            <div class="mobile-navbar-icon icon-out" id="mobile-nav-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <nav class="mobile-menu" id="mobile-menu">
            <ul class="mobile-menu-list">
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org">
                        Home
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;categories">
                        Categories
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;archive">
                        Archive
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;about">
                        About
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;projects">
                        Projects
                    </a>
                </li>
                
            </ul>
        </nav>

        <header>
            <div class="title">
                <a href="https:&#x2F;&#x2F;blog.mapotofu.org">Cyanide</a>
            </div>
            <nav class="menu">
                <ul>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org">
                            Home
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;categories">
                            Categories
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;archive">
                            Archive
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;about">
                            About
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;projects">
                            Projects
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </header>

        <hr class="gradient">

        <main>
            <div class="content">
                

<div class="toc">
    <h2 class="toc-title">Contents</h2>
    <div class="toc-content always-active">
        <ul>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/deep-learning-serving/#basic-features" class="toc-link">Basic features</a>
                
            </li>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/deep-learning-serving/#advantages" class="toc-link">Advantages</a>
                
            </li>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/deep-learning-serving/#design" class="toc-link">Design</a>
                
                <ul>
                    
                    <li>
                        <a href="https://blog.mapotofu.org/blogs/deep-learning-serving/#dynamic-batching" class="toc-link">Dynamic Batching</a>
                    </li>
                    
                    <li>
                        <a href="https://blog.mapotofu.org/blogs/deep-learning-serving/#error-handling" class="toc-link">Error handling</a>
                    </li>
                    
                    <li>
                        <a href="https://blog.mapotofu.org/blogs/deep-learning-serving/#simple-http-service-without-dynamic-batching" class="toc-link">Simple HTTP service without dynamic batching</a>
                    </li>
                    
                </ul>
                
            </li>
            
        </ul>
    </div>
</div>


<article class="post">
    <div class="post-title">
        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;blogs&#x2F;deep-learning-serving&#x2F;">Deep Learning Serving Framework</a>
    </div>
    <div class="post-meta">
        <span class="post-time">
            ðŸ“… 2020-05-13
        </span>
        <span class="post-reading-time">
            âŒ› 5 min
        </span>
        
        <div class="post-category">
            
            <a href="https://blog.mapotofu.org/categories/deep-learning/">
                Deep Learning
            </a>
            
            <a href="https://blog.mapotofu.org/categories/technology/">
                Technology
            </a>
            
            <a href="https://blog.mapotofu.org/categories/data-science/">
                Data Science
            </a>
            
        </div>
        
    </div>
    <div class="post-content">
        <p>Yet another deep learning serving framework that is easy to use.</p>
<span id="continue-reading"></span>
<p>Previously, I tested the performance of some <a href="https://blog.mapotofu.org/blogs/serving-benchmark/">deep learning serving frameworks</a> like TensorFlow Serving, Triton, and I found that these frameworks are not that easy to use. By the way, they don't have much advantage in the performance. So I just write one as a prototype.</p>
<ul>
<li><a href="https://github.com/kemingy/ventu">ventu</a></li>
<li><a href="https://github.com/kemingy/batching">batching</a></li>
</ul>
<p><del>Feel free to give it a try.</del> For production usage, check the <a href="https://github.com/mosecorg/mosec">MOSEC</a>.</p>
<h2 id="basic-features">Basic features</h2>
<ul>
<li>serve the deep learning models (HTTP)</li>
<li>preprocess and postprocess (optional)</li>
<li>dynamic batching (increase the throughput)</li>
<li>load balancing (idle workers first)</li>
<li>monitoring metrics (Prometheus)</li>
<li>health check (need to provide examples)</li>
<li>request &amp; response validation</li>
<li>model inference warm-up (need to provide examples)</li>
<li>OpenAPI document</li>
<li>supports both JSON and msgpack serialization</li>
</ul>
<h2 id="advantages">Advantages</h2>
<ul>
<li>support all kinds of deep learning runtime</li>
<li>easy to implement the preprocess and postprocess part</li>
<li>validation for request</li>
<li>health check and warm-up with examples</li>
<li>OpenAPI document</li>
</ul>
<h2 id="design">Design</h2>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>                                       +-----------+
</span><span>                                       | Inference |
</span><span>                               +-------+ Worker    |
</span><span>                               |       +-----------+
</span><span>+----------+        +--------+ |
</span><span>|          |        |        +-+       +-----------+
</span><span>| Batching |        | Unix   |         | Inference |
</span><span>| Service  +--------&gt; Domain +---------+ Worker    |
</span><span>| (HTTP)   &lt;--------+ Socket |         +-----------+
</span><span>|          |        |        +-+
</span><span>+----------+        +--------+ |       +-----------+
</span><span>                               |       | Inference |
</span><span>                               +-------+ Worker    |
</span><span>                                       +-----------+
</span></code></pre>
<h3 id="dynamic-batching">Dynamic Batching</h3>
<p>To implement the dynamic batching, we need a high-performance job queue that can be consumed by multiple workers. Go channel will be a good choice. In this situation, we have one producer and multiple consumers, so it's very easy to close the channel for the graceful shutdown.</p>
<pre data-lang="go" style="background-color:#ffffff;color:#4d4d4c;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#8959a8;">type </span><span>Batching </span><span style="color:#8959a8;">struct </span><span>{
</span><span>	</span><span style="color:#c82829;">Name       </span><span style="color:#c99e00;">string </span><span style="color:#999999;">// socket name
</span><span>	</span><span style="color:#c82829;">socket     net</span><span>.</span><span style="color:#8959a8;">Listener
</span><span>	</span><span style="color:#c82829;">maxLatency time</span><span>.</span><span style="color:#8959a8;">Duration </span><span style="color:#999999;">// max latency for a batch inference to wait
</span><span>	</span><span style="color:#c82829;">batchSize  </span><span style="color:#c99e00;">int </span><span style="color:#999999;">// max batch size for a batch inference
</span><span>	</span><span style="color:#c82829;">capacity   </span><span style="color:#c99e00;">int </span><span style="color:#999999;">// the capacity of the batching queue
</span><span>	</span><span style="color:#c82829;">timeout    time</span><span>.</span><span style="color:#8959a8;">Duration </span><span style="color:#999999;">// timeout for jobs in the queue
</span><span>	</span><span style="color:#c82829;">logger     </span><span style="color:#3e999f;">*</span><span style="color:#c82829;">zap</span><span>.</span><span style="color:#8959a8;">Logger
</span><span>	</span><span style="color:#c82829;">queue      </span><span style="color:#8959a8;">chan </span><span style="color:#3e999f;">*</span><span style="color:#8959a8;">Job </span><span style="color:#999999;">// job queue
</span><span>	</span><span style="color:#c82829;">jobs       </span><span style="color:#8959a8;">map</span><span>[</span><span style="color:#c99e00;">string</span><span>]</span><span style="color:#3e999f;">*</span><span style="color:#8959a8;">Job </span><span style="color:#999999;">// use job id as the key to find the job
</span><span>	</span><span style="color:#c82829;">jobsLock   sync</span><span>.</span><span style="color:#8959a8;">Mutex </span><span style="color:#999999;">// lock for jobs
</span><span>}
</span></code></pre>
<p>For jobs in this queue, we need to create a UUID as a key. So after the inference, we can find this job by searching the key in a hash table. That means we also need a mutex for the hash table.</p>
<pre data-lang="go" style="background-color:#ffffff;color:#4d4d4c;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#8959a8;">type </span><span>Job </span><span style="color:#8959a8;">struct </span><span>{
</span><span>	</span><span style="color:#c82829;">id        </span><span style="color:#c99e00;">string
</span><span>	</span><span style="color:#c82829;">done      </span><span style="color:#8959a8;">chan </span><span style="color:#c99e00;">bool
</span><span>	</span><span style="color:#c82829;">data      </span><span>[]</span><span style="color:#c99e00;">byte </span><span style="color:#999999;">// request data
</span><span>	</span><span style="color:#c82829;">result    </span><span>[]</span><span style="color:#c99e00;">byte </span><span style="color:#999999;">// inference result or error message
</span><span>	</span><span style="color:#c82829;">errorCode </span><span style="color:#c99e00;">int </span><span style="color:#999999;">// HTTP Error Code
</span><span>	</span><span style="color:#c82829;">expire    time</span><span>.</span><span style="color:#8959a8;">Time
</span><span>}
</span></code></pre>
<p>Because the batching service and Python inference workers are on the same machine (or the same pod), so the most efficient communication should be the <a href="https://en.wikipedia.org/wiki/Unix_domain_socket">Unix domain socket</a>. And we also need to define a simple protocol for our use case. Since we only need to transfer the data of a batch jobs, let's keep everything as simple as we can.</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>| length  |       data        |
</span><span>| 4 bytes |   {length} bytes  |
</span></code></pre>
<p>Data used in this protocol is a hash table <code>&lt;string:bytes&gt;</code>.</p>
<ol>
<li>workers send the first request with empty data to the batching service</li>
<li>batching service collects a batch of jobs and sends to the workers</li>
<li>worker processes these jobs
<ul>
<li>preprocess (for a single job)</li>
<li>inference (for a batch of jobs)</li>
<li>postprocess (for a single job)</li>
<li>send to the results to the batching service</li>
</ul>
</li>
<li>batching service notifies the handler that this job is done, then the handler sends the result to the original client and goes to #2</li>
</ol>
<h3 id="error-handling">Error handling</h3>
<ul>
<li>timeout</li>
</ul>
<p>If a job is not processed by one of the workers for a long time, the batching service will delete this job from the hash table and return 408.</p>
<p>When the batching service tries to collect these jobs from the queue channel, it will check the <code>expire</code> attribute first.</p>
<ul>
<li>validation error</li>
</ul>
<p>To make sure the requested data is valid, we use <a href="pydantic-docs.helpmanual.io/">pydantic</a> to do the validation. So the user needs to define the data schema with <code>pydantic</code>.</p>
<p>If one job data is invalid, this one will be marked and the result for this job is the validation error message generated by <code>pydantic</code>. And this won't affect other jobs in the same batch. That part is handled by the <code>ventu</code>.</p>
<ul>
<li>pass the errors from the workers to the batching service</li>
</ul>
<p>The data received by workers will be validated first. If some of the jobs are invalided, the job ids will be put into a error ids array. Only the valid jobs will be processed through the <code>preprocess -&gt; inference -&gt; postprocess</code> progress. After that, the results will be:</p>
<pre data-lang="json" style="background-color:#ffffff;color:#4d4d4c;" class="language-json "><code class="language-json" data-lang="json"><span>{
</span><span>	</span><span style="background-color:#c82829;color:#ffffff;">&#39;valid</span><span> </span><span style="background-color:#c82829;color:#ffffff;">job</span><span> </span><span style="background-color:#c82829;color:#ffffff;">ID&#39;</span><span>: </span><span style="background-color:#c82829;color:#ffffff;">inference</span><span> </span><span style="background-color:#c82829;color:#ffffff;">result</span><span>
</span><span>	</span><span style="background-color:#c82829;color:#ffffff;">&#39;error</span><span> </span><span style="background-color:#c82829;color:#ffffff;">job</span><span> </span><span style="background-color:#c82829;color:#ffffff;">ID&#39;</span><span>: </span><span style="background-color:#c82829;color:#ffffff;">error</span><span> </span><span style="background-color:#c82829;color:#ffffff;">message</span><span>
</span><span>	</span><span style="background-color:#c82829;color:#ffffff;">&#39;`error_id`&#39;</span><span>: </span><span style="background-color:#c82829;color:#ffffff;">all</span><span> </span><span style="background-color:#c82829;color:#ffffff;">the</span><span> </span><span style="background-color:#c82829;color:#ffffff;">error</span><span> </span><span style="background-color:#c82829;color:#ffffff;">job</span><span> </span><span style="background-color:#c82829;color:#ffffff;">IDs</span><span>
</span><span>}
</span></code></pre>
<p>When the batching server receives these data, it will mark the error jobs' status code as 422. After that, all the jobs in this batch will be attached with the corresponding results and marked as done. So the handler know this job has validation errors and can return the error message to the client.</p>
<h3 id="simple-http-service-without-dynamic-batching">Simple HTTP service without dynamic batching</h3>
<p>For this part, we use <a href="falcon.readthedocs.io/">falcon</a> which is a very powerful Python framework for web APIs. To generate the OpenAPI document and validate the request data, we use <a href="https://github.com/0b01001001/spectree">spectree</a>.</p>
<p>If you would like to use <code>gunicorn</code>, <code>ventu</code> also expose the <code>app</code> element.</p>

    </div>

    <div class="post-before-footer">
        
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License"
        style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work is
licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons
    Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

    </div>

    <div class="post-footer">
        
            
            <div class="post-nav">
                
                <a class="previous" href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;blogs&#x2F;serving-benchmark&#x2F;">â€¹ Deep Learning Serving Benchmark</a>
                
                
                <a class="next" href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;blogs&#x2F;mapreduce&#x2F;">Note for MapReduce â€º</a>
                
                
                
            </div>
            
        
    </div>
</article>

            </div>
        </main>

        
        
    </div>

    
    <script src="https://blog.mapotofu.org/script.js"></script>
    
</body>

</html>