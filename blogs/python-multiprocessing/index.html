<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>
Cyanide - Why not multiprocessing
</title>

    <link rel="stylesheet" href="https://blog.mapotofu.org/style.css">

    
    <link rel="alternate" type="application/atom+xml" title="RSS"
        href="https://blog.mapotofu.org/atom.xml">
    

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
        integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
        integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
        integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {delimiters:[
        {left: '$$', right: '$$', display: true},
        {left: '\\[', right: '\\]', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false}]});"></script>
    

    
<meta name="google-site-verification" content="OEmuX--u8eJZ_sTIR-hUG85I8snl3z0En6PspWN-OJQ" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ–‹</text></svg>">

</head>

<body>
    <div class="container">
        <div class="mobile-navbar">
            <div class="mobile-header">
                <a href="/" class="title">Cyanide</a>
            </div>
            <div class="mobile-navbar-icon icon-out" id="mobile-nav-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <nav class="mobile-menu" id="mobile-menu">
            <ul class="mobile-menu-list">
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org">
                        Home
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;categories">
                        Categories
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;archive">
                        Archive
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;about">
                        About
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;projects">
                        Projects
                    </a>
                </li>
                
            </ul>
        </nav>

        <header>
            <div class="title">
                <a href="https:&#x2F;&#x2F;blog.mapotofu.org">Cyanide</a>
            </div>
            <nav class="menu">
                <ul>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org">
                            Home
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;categories">
                            Categories
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;archive">
                            Archive
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;about">
                            About
                        </a>
                    </li>
                    
                    <li>
                        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;projects">
                            Projects
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </header>

        <hr class="gradient">

        <main>
            <div class="content">
                

<div class="toc">
    <h2 class="toc-title">Contents</h2>
    <div class="toc-content always-active">
        <ul>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/python-multiprocessing/#start-from-a-segment-fault" class="toc-link">start from a segment fault</a>
                
            </li>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/python-multiprocessing/#fork-or-spawn" class="toc-link">fork or spawn</a>
                
            </li>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/python-multiprocessing/#garbage-collection-with-deadlock" class="toc-link">garbage collection with deadlock</a>
                
            </li>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/python-multiprocessing/#copy-on-write" class="toc-link">Copy on write</a>
                
            </li>
            
            <li>
                <a href="https://blog.mapotofu.org/blogs/python-multiprocessing/#suggestions" class="toc-link">Suggestions</a>
                
            </li>
            
        </ul>
    </div>
</div>


<article class="post">
    <div class="post-title">
        <a href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;blogs&#x2F;python-multiprocessing&#x2F;">Why not multiprocessing</a>
    </div>
    <div class="post-meta">
        <span class="post-time">
            ðŸ“… 2021-09-29
        </span>
        <span class="post-reading-time">
            âŒ› 10 min
        </span>
        
        <div class="post-category">
            
            <a href="https://blog.mapotofu.org/categories/technology/">
                Technology
            </a>
            
            <a href="https://blog.mapotofu.org/categories/python/">
                Python
            </a>
            
        </div>
        
    </div>
    <div class="post-content">
        <p>Be careful to use multiprocessing in production.</p>
<span id="continue-reading"></span><h2 id="start-from-a-segment-fault">start from a segment fault</h2>
<p>Here is a code snippet that will run well on Darwin but trigger a segment fault on Unix.</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">import </span><span>multiprocessing </span><span style="color:#8959a8;">as </span><span>mp
</span><span style="color:#8959a8;">from </span><span>time </span><span style="color:#8959a8;">import </span><span>sleep
</span><span>
</span><span>
</span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">wait_for_event</span><span>(</span><span style="color:#f5871f;">event</span><span>):
</span><span>    </span><span style="color:#8959a8;">while </span><span style="color:#3e999f;">not </span><span style="color:#4271ae;">event.</span><span style="color:#c82829;">is_set</span><span style="color:#4271ae;">()</span><span>:
</span><span>        </span><span style="color:#c82829;">sleep</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">0.1</span><span style="color:#4271ae;">)
</span><span>
</span><span>
</span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">trigger_segment_fault</span><span>():
</span><span>    event </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">mp.</span><span style="color:#c82829;">Event</span><span style="color:#4271ae;">()
</span><span>    p </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">mp.</span><span style="color:#c82829;">get_context</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;spawn&quot;</span><span style="color:#4271ae;">).</span><span style="color:#c82829;">Process</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">target</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">wait_for_event, </span><span style="color:#f5871f;">args</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">(event,))
</span><span>    </span><span style="color:#4271ae;">p.</span><span style="color:#c82829;">start</span><span style="color:#4271ae;">()  </span><span style="color:#999999;"># this will show the exitcode=-SIGSEGV
</span><span>    </span><span style="color:#c82829;">sleep</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">1</span><span style="color:#4271ae;">)
</span><span>    </span><span style="color:#4271ae;">print(p)
</span><span>    </span><span style="color:#4271ae;">event.</span><span style="color:#c82829;">set</span><span style="color:#4271ae;">()
</span><span>    </span><span style="color:#4271ae;">p.</span><span style="color:#c82829;">terminate</span><span style="color:#4271ae;">()
</span><span>
</span><span>
</span><span style="color:#8959a8;">if </span><span>__name__ </span><span style="color:#3e999f;">== </span><span style="color:#718c00;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#c82829;">trigger_segment_fault</span><span style="color:#4271ae;">()
</span></code></pre>
<p>Yeah, the pure Python code can trigger a segment fault.</p>
<p>The reason is because of the new process start method. According to the <a href="https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods">Python document</a>, <code>spawn</code> is the default one on macOS (start from Python 3.8) while <code>fork</code> is the default one on Unix. But the start method also affects the <code>Event</code> creation. Let's check the source code:</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">class </span><span style="color:#c99e00;">Event</span><span>(</span><span style="color:#718c00;">object</span><span>):
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">__init__</span><span>(</span><span style="color:#f5871f;">self</span><span>, </span><span style="color:#3e999f;">*</span><span>, </span><span style="color:#f5871f;">ctx</span><span>):
</span><span>        </span><span style="color:#c82829;">self</span><span>._cond </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">ctx.</span><span style="color:#c82829;">Condition</span><span style="color:#4271ae;">(ctx.</span><span style="color:#c82829;">Lock</span><span style="color:#4271ae;">())
</span><span>        </span><span style="color:#c82829;">self</span><span>._flag </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">ctx.</span><span style="color:#c82829;">Semaphore</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">0</span><span style="color:#4271ae;">)
</span></code></pre>
<p>The initialization takes a <code>ctx</code> which is related to the start method. So when you try to access a forked event in a spawned process, this segment fault occurs. The way to solve this is simple -- using the same context. (Actually, you can use the <em>spawn</em> event in the forked process)</p>
<h2 id="fork-or-spawn"><em>fork</em> or <em>spawn</em></h2>
<p>Another question is that, which start method should I use?</p>
<blockquote>
<p><em>spawn</em>: The parent process starts a <strong>fresh</strong> python interpreter process. The child process will only inherit those resources necessary to run the process objects run() method. In particular, unnecessary file descriptors and handles from the parent process will not be inherited.</p>
</blockquote>
<blockquote>
<p><em>fork</em>: The parent process uses <code>os.fork()</code> to fork the Python interpreter. The child process, when it begins, is effectively identical to the parent process. All resources of the parent are inherited by the child's process. Note that safely forking a multithreaded process is <strong>problematic</strong>.</p>
</blockquote>
<p>We can see that <em>spawn</em> will create a new Python process and only inherit necessary resources. <em>fork</em> will call the underlying <code>os.fork()</code>, but the implementation in CPython is problematic.</p>
<p>When you are using <em>spawn</em>, accidentally access the main process variables may have some unexpected consequences.</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">import </span><span>multiprocessing </span><span style="color:#8959a8;">as </span><span>mp
</span><span style="color:#8959a8;">import </span><span>os
</span><span>
</span><span>
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">Dummy</span><span>:
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">__init__</span><span>(</span><span style="color:#f5871f;">self</span><span>) -&gt; </span><span style="color:#f5871f;">None</span><span>:
</span><span>        </span><span style="color:#4271ae;">print(</span><span style="color:#8959a8;">f</span><span style="color:#718c00;">&quot;init in pid: </span><span style="color:#4271ae;">{os.</span><span style="color:#c82829;">getpid</span><span style="color:#4271ae;">()}</span><span style="color:#718c00;">&quot;</span><span style="color:#4271ae;">)
</span><span>
</span><span>
</span><span style="color:#c82829;">Dummy</span><span style="color:#4271ae;">()
</span><span>x </span><span style="color:#3e999f;">= </span><span style="color:#f5871f;">None
</span><span>
</span><span>
</span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">task</span><span>():
</span><span>    </span><span style="color:#8959a8;">if </span><span>x </span><span style="color:#3e999f;">is </span><span style="color:#f5871f;">None</span><span>:
</span><span>        </span><span style="color:#4271ae;">print(</span><span style="color:#718c00;">&quot;x is None&quot;</span><span style="color:#4271ae;">)
</span><span>
</span><span>
</span><span style="color:#8959a8;">if </span><span>__name__ </span><span style="color:#3e999f;">== </span><span style="color:#718c00;">&quot;__main__&quot;</span><span>:
</span><span>    p </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">mp.</span><span style="color:#c82829;">get_context</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;spawn&quot;</span><span style="color:#4271ae;">).</span><span style="color:#c82829;">Process</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">target</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">task)
</span><span>    </span><span style="color:#4271ae;">p.</span><span style="color:#c82829;">start</span><span style="color:#4271ae;">()
</span><span>    </span><span style="color:#4271ae;">p.</span><span style="color:#c82829;">join</span><span style="color:#4271ae;">()
</span></code></pre>
<p>In the above code snippet, if the <em>spawn</em> process tries to access the variable <code>x</code>, it will trigger the initialization of both <code>Dummy()</code> and <code>x = None</code>. So you can see the terminal will print two &quot;init in pid&quot; with different PIDs.</p>
<p>So what kind of problem can the <em>fork</em> cause? Let's take a look at this article: <a href="https://pythonspeed.com/articles/python-multiprocessing/">Why your multiprocessing Pool is stuck (itâ€™s full of sharks!)</a>. </p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">import </span><span>threading
</span><span style="color:#8959a8;">import </span><span>os
</span><span style="color:#8959a8;">import </span><span>time
</span><span style="color:#8959a8;">import </span><span>multiprocessing </span><span style="color:#8959a8;">as </span><span>mp
</span><span>
</span><span>
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">AreYouOK</span><span>:
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">__init__</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#4271ae;">print(</span><span style="color:#718c00;">&quot;init in:&quot;</span><span style="color:#4271ae;">, os.</span><span style="color:#c82829;">getpid</span><span style="color:#4271ae;">())
</span><span>        </span><span style="color:#c82829;">self</span><span>.lock </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">threading.</span><span style="color:#c82829;">Lock</span><span style="color:#4271ae;">()
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">check</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#8959a8;">if </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.lock.</span><span style="color:#c82829;">locked</span><span style="color:#4271ae;">()</span><span>:
</span><span>            </span><span style="color:#8959a8;">return </span><span style="color:#f5871f;">False
</span><span>        </span><span style="color:#8959a8;">return </span><span style="color:#f5871f;">True
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">acquire</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.lock.</span><span style="color:#c82829;">acquire</span><span style="color:#4271ae;">()
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">delay_release</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#4271ae;">time.</span><span style="color:#c82829;">sleep</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">1</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.lock.</span><span style="color:#c82829;">release</span><span style="color:#4271ae;">()
</span><span>
</span><span>
</span><span>greeter </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">AreYouOK</span><span style="color:#4271ae;">()
</span><span style="color:#4271ae;">greeter.</span><span style="color:#c82829;">acquire</span><span style="color:#4271ae;">()
</span><span>
</span><span style="color:#4271ae;">threading.</span><span style="color:#c82829;">Thread</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">target</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">greeter.delay_release, </span><span style="color:#f5871f;">daemon</span><span style="color:#3e999f;">=</span><span style="color:#f5871f;">True</span><span style="color:#4271ae;">).</span><span style="color:#c82829;">start</span><span style="color:#4271ae;">()
</span><span>
</span><span>
</span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">greeting</span><span>():
</span><span>    </span><span style="color:#4271ae;">time.</span><span style="color:#c82829;">sleep</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">1</span><span style="color:#4271ae;">)
</span><span>    </span><span style="color:#4271ae;">print(os.</span><span style="color:#c82829;">getpid</span><span style="color:#4271ae;">(), greeter.</span><span style="color:#c82829;">check</span><span style="color:#4271ae;">())
</span><span>
</span><span>
</span><span style="color:#8959a8;">if </span><span>__name__ </span><span style="color:#3e999f;">== </span><span style="color:#718c00;">&quot;__main__&quot;</span><span>:
</span><span>    </span><span style="color:#4271ae;">mp.</span><span style="color:#c82829;">get_context</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;fork&quot;</span><span style="color:#4271ae;">).</span><span style="color:#c82829;">Process</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">target</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">greeting).</span><span style="color:#c82829;">start</span><span style="color:#4271ae;">()
</span><span>    </span><span style="color:#c82829;">greeting</span><span style="color:#4271ae;">()
</span></code></pre>
<p>In the above example, after the lock is released, the child process still cannot acquire the lock. Why?</p>
<p>The main point is that fork doesn't copy everything.</p>
<p>Let's check the <a href="https://man7.org/linux/man-pages/man2/fork.2.html">man page of fork</a>:</p>
<blockquote>
<p>The child does not inherit its parent's memory locks</p>
</blockquote>
<blockquote>
<p>The child does not inherit semaphore adjustments from its parent</p>
</blockquote>
<p>So what happens here is that the child process has a lock already been acquired, but no thread will release the lock because that running thread won't be copied to the <em>fork</em> process. These two locks are not the same (copied not shared). Here, the <code>threading.Lock</code> is obviously not process-safe and should be handled with cautions when it's used in some other libraries (<code>queue.Queue</code>).</p>
<p>If we use <em>spawn</em> instead of <em>fork</em>, everything related will be <strong>rebuilt</strong> in the new process (including the Thread). That's why  we should use <em>spawn</em> instead of <em>fork</em>:</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">from </span><span>multiprocessing </span><span style="color:#8959a8;">import </span><span>set_start_method
</span><span style="color:#c82829;">set_start_method</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;spawn&quot;</span><span style="color:#4271ae;">)
</span></code></pre>
<p>The code snippet above may cause some problems when the code is executed more than once.</p>
<p>My suggestion is to use the start method context:</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">import </span><span>multiprocessing </span><span style="color:#8959a8;">as </span><span>mp
</span><span>
</span><span>
</span><span>context </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">mp.</span><span style="color:#c82829;">get_context</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;spawn&quot;</span><span style="color:#4271ae;">)
</span><span style="color:#4271ae;">context.</span><span style="color:#c82829;">Event</span><span style="color:#4271ae;">()
</span></code></pre>
<h2 id="garbage-collection-with-deadlock">garbage collection with deadlock</h2>
<p>Let's take a look at another article: <a href="https://codewithoutrules.com/2017/08/16/concurrency-python/">The tragic tale of the deadlocking Python queue</a>.</p>
<blockquote>
<p>This code snippet is copied from the above article.</p>
</blockquote>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">from </span><span>queue </span><span style="color:#8959a8;">import </span><span>Queue
</span><span>
</span><span>q </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">Queue</span><span style="color:#4271ae;">()
</span><span>
</span><span>
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">Circular</span><span>(</span><span style="color:#718c00;">object</span><span>):
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">__init__</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#c82829;">self</span><span>.circular </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">self
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">__del__</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#4271ae;">print(</span><span style="color:#718c00;">&quot;Adding to queue in GC&quot;</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#4271ae;">q.</span><span style="color:#c82829;">put</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">1</span><span style="color:#4271ae;">)
</span><span>
</span><span>
</span><span style="color:#8959a8;">for </span><span>i </span><span style="color:#8959a8;">in </span><span style="color:#4271ae;">range(</span><span style="color:#f5871f;">1000000000</span><span style="color:#4271ae;">)</span><span>:
</span><span>    </span><span style="color:#4271ae;">print(</span><span style="color:#718c00;">&quot;iteration&quot;</span><span style="color:#4271ae;">, i)
</span><span>    </span><span style="color:#999999;"># Create an object that will be garbage collected
</span><span>    </span><span style="color:#999999;"># asynchronously, and therefore have its __del__
</span><span>    </span><span style="color:#999999;"># method called later:
</span><span>    </span><span style="color:#c82829;">Circular</span><span style="color:#4271ae;">()
</span><span>    </span><span style="color:#4271ae;">print(</span><span style="color:#718c00;">&quot;Adding to queue regularly&quot;</span><span style="color:#4271ae;">)
</span><span>    </span><span style="color:#4271ae;">q.</span><span style="color:#c82829;">put</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">2</span><span style="color:#4271ae;">)
</span></code></pre>
<p>Usually, we believe that Python runs one line at a time. But that's not true.</p>
<blockquote>
<p>Garbage collection can interrupt Python functions at any point, and run arbitrary other Python code: <code>__del__</code> methods and <a href="https://docs.python.org/3/library/weakref.html">weakref</a> callbacks. So can signal handlers, which happen e.g. when you hit Ctrl-C (your process gets the SIGINT signal) or a subprocess dies (your process gets the SIGCHLD signal).</p>
</blockquote>
<p>So when we try to <code>q.put(2)</code>, the queue needs to acquire the lock. Meanwhile, the GC will try to call the <code>__del__</code> which also does the <code>q.put(1)</code>. The <code>q.put(2)</code> is blocked by the GC, but the GC cannot acquire the lock because <code>q.put(2)</code> won't release it. Deadlock happens!</p>
<p>Thanks to the Python-dev team, this has been fixed in Python 3.7 by introducing the <code>SimpleQueue</code>.</p>
<h2 id="copy-on-write">Copy on write</h2>
<p>When running with multiprocessing, we hope the child process can share some data with the main process instead of copying from it. Especially when they are not used in the child process. This sounds reasonable. However, we missed another important part in Python: reference counting.</p>
<p>CPython contains two kinds of garbage collection methods: reference counting and generational garbage collection. The reference counting is the fundamental one and cannot be disabled. The generational garbage collection is mainly used to solve the reference cycles. Check this article for more details: <a href="https://rushter.com/blog/python-garbage-collector/">Garbage collection in Python: things you need to know</a> and <a href="https://devguide.python.org/garbage_collector/">Design of CPythonâ€™s Garbage Collector</a>.</p>
<p>Let's take a look at the CPython implementation of PyObject:</p>
<pre data-lang="c" style="background-color:#ffffff;color:#4d4d4c;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#8959a8;">typedef struct</span><span> _object {
</span><span>    _PyObject_HEAD_EXTRA
</span><span>    Py_ssize_t ob_refcnt;
</span><span>    PyTypeObject </span><span style="color:#3e999f;">*</span><span>ob_type;
</span><span>} PyObject;
</span></code></pre>
<p>There is a class member called <code>ob_refcnt</code> which is used to track the reference counting. If we call <code>fork()</code> in the new process, the reference counting of all the Python objects will increase. This means the object itself has changed although the data accessed by the user is still the same.</p>
<!-- 
```python
import sys
import multiprocessing as mp


data = list(range(1000))

def get_ref_count():
    print("child process", sys.getrefcount(data))


if __name__ == "__main__":
    print("main process:", sys.getrefcount(data))
    p = mp.get_context("spawn").Process(target=get_ref_count)
    p.start()
    p.join()
```

If we run the code above, we will see that the default reference count is 2 (because the function `sys.getrefcount()` will increase it by 1). In the child process, the reference count has changed to 3. -->
<p>To handle this problem, the Instagram Engineering team has come up with a solution: <a href="https://instagram-engineering.com/copy-on-write-friendly-python-garbage-collection-ad6ed5233ddf">Copy-on-write friendly Python garbage collection</a>.</p>
<pre data-lang="c" style="background-color:#ffffff;color:#4d4d4c;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#8959a8;">static</span><span> PyObject </span><span style="color:#3e999f;">*
</span><span style="color:#4271ae;">gc_freeze_impl</span><span>(PyObject </span><span style="color:#3e999f;">*</span><span style="color:#f5871f;">module</span><span>)
</span><span style="color:#999999;">/*[clinic end generated code: output=502159d9cdc4c139 input=b602b16ac5febbe5]*/
</span><span>{
</span><span>    GCState </span><span style="color:#3e999f;">*</span><span>gcstate </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">get_gc_state</span><span style="color:#4271ae;">()</span><span>;
</span><span>    </span><span style="color:#8959a8;">for </span><span>(</span><span style="color:#8959a8;">int</span><span> i </span><span style="color:#3e999f;">= </span><span style="color:#f5871f;">0</span><span>; i </span><span style="color:#3e999f;">&lt;</span><span> NUM_GENERATIONS; </span><span style="color:#3e999f;">++</span><span>i) {
</span><span>        </span><span style="color:#c82829;">gc_list_merge</span><span style="color:#4271ae;">(</span><span style="color:#c82829;">GEN_HEAD</span><span style="color:#4271ae;">(gcstate, i), </span><span style="color:#3e999f;">&amp;</span><span style="color:#4271ae;">gcstate-&gt;permanent_generation.</span><span style="color:#c82829;">head</span><span style="color:#4271ae;">)</span><span>;
</span><span>        gcstate-&gt;generations[i].</span><span style="color:#c82829;">count </span><span style="color:#3e999f;">= </span><span style="color:#f5871f;">0</span><span>;
</span><span>    }
</span><span>    Py_RETURN_NONE;
</span><span>}
</span></code></pre>
<p>Let's check the <a href="https://docs.python.org/3/library/gc.html#gc.freeze">Python document for GC</a>. In Python 3.7, it introduced a new method called <code>gc.freeze</code>:</p>
<blockquote>
<p>Freeze all the objects tracked by gc - move them to a permanent generation and ignore all the future collections.</p>
</blockquote>
<!-- Let's modify the code to:

```python
import sys
import gc
import multiprocessing as mp


data = list(range(1000))

def get_ref_count():
    print("child process", sys.getrefcount(data))


if __name__ == "__main__":
    gc.freeze()
    print("main process:", sys.getrefcount(data))
    p = mp.get_context("spawn").Process(target=get_ref_count)
    p.start()
    p.join()
```

It works now. The reference count in the child process is the same as the main process. -->
<p>So will this solve the Copy-on-write problem? I'm not sure because I cannot come up with an example to reproduce it.</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">import </span><span>time
</span><span style="color:#8959a8;">import </span><span>psutil
</span><span style="color:#8959a8;">import </span><span>multiprocessing </span><span style="color:#8959a8;">as </span><span>mp
</span><span>
</span><span>
</span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">display_memory_usage</span><span>(</span><span style="color:#f5871f;">msg</span><span style="color:#3e999f;">=</span><span style="color:#718c00;">&quot;&quot;</span><span>):
</span><span>    process </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">psutil.</span><span style="color:#c82829;">Process</span><span style="color:#4271ae;">()
</span><span>    </span><span style="color:#4271ae;">print(msg, </span><span style="color:#718c00;">&quot;&gt;&quot;</span><span style="color:#4271ae;">, process.</span><span style="color:#c82829;">memory_info</span><span style="color:#4271ae;">())
</span><span>
</span><span>
</span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">processing</span><span>():
</span><span>    </span><span style="color:#c82829;">display_memory_usage</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;child &quot;</span><span style="color:#4271ae;">)
</span><span>
</span><span>
</span><span style="color:#8959a8;">if </span><span>__name__ </span><span style="color:#3e999f;">== </span><span style="color:#718c00;">&quot;__main__&quot;</span><span>:
</span><span>    data </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">list</span><span style="color:#4271ae;">(range(</span><span style="color:#f5871f;">10000000</span><span style="color:#4271ae;">))
</span><span>
</span><span>    p </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">mp.</span><span style="color:#c82829;">get_context</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;fork&quot;</span><span style="color:#4271ae;">).</span><span style="color:#c82829;">Process</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">target</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">processing)
</span><span>    </span><span style="color:#4271ae;">p.</span><span style="color:#c82829;">start</span><span style="color:#4271ae;">()
</span><span>
</span><span>    </span><span style="color:#4271ae;">time.</span><span style="color:#c82829;">sleep</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">0.1</span><span style="color:#4271ae;">)
</span><span>    </span><span style="color:#c82829;">display_memory_usage</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;parent&quot;</span><span style="color:#4271ae;">)
</span><span>    </span><span style="color:#4271ae;">p.</span><span style="color:#c82829;">join</span><span style="color:#4271ae;">()
</span></code></pre>
<p>The code snippet above will print the memory usage of the main process and child process. You may get something like this:</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>child  &gt; pmem(rss=414748672, vms=427634688, shared=2969600, text=2035712, lib=0, data=411791360, dirty=0)
</span><span>parent &gt; pmem(rss=419000320, vms=427634688, shared=7221248, text=2035712, lib=0, data=411791360, dirty=0)
</span></code></pre>
<p>We can see that they don't share a lot. Although by default, the <em>fork</em> process should share the data with the parent process.</p>
<p>But if we change it to <em>spawn</em>, we will get something like this:</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>child  &gt; pmem(rss=13848576, vms=23044096, shared=7069696, text=2035712, lib=0, data=7163904, dirty=0)
</span><span>parent &gt; pmem(rss=419139584, vms=428081152, shared=7196672, text=2035712, lib=0, data=412200960, dirty=0)
</span></code></pre>
<p>Since the <code>data</code> is not used by the <em>spawn</em> process, so this won't be copied to the new process.</p>
<p>I try to add the <code>gc.freeze()</code> before creating a new process, but it doesn't work at all. Not sure what I have missed.</p>
<p>I found that some discussion in the <a href="https://github.com/python/cpython/pull/3705#issuecomment-420191452"><code>gc.freeze()</code> PR</a>. It looks that the untouched data should be able to share among processes. Also, it has been 4 years for Gunicorn to process this <a href="https://github.com/benoitc/gunicorn/issues/1640">support for <code>gc.freeze()</code> for apps that use preloading</a>. I cannot found a good example to demonstrate that this method works well.</p>
<p>To my understanding, the <code>gc.freeze()</code> will disable the generational garbage collection. But the reference counting cannot be disabled. So if we <em>fork</em> a new process, everything will be shared with the new process, which means it will change all the reference count.</p>
<p>If we change the start method from <em>spawn</em> to <em>fork</em>, it doesn't need the <code>gc.freeze()</code> to freeze the reference count, which has conflicts with the description in the Instagram blog.</p>
<p>Is there any method to avoid this? Yes. Check another blog written before the Instagram blog: <a href="https://llvllatrix.wordpress.com/2016/02/19/python-vs-copy-on-write/">Python vs Copy on Write</a>. The solution is very straightforward:</p>
<ul>
<li>You can just use the <a href="https://www.pypy.org/">PyPy</a> because it has <a href="https://doc.pypy.org/en/latest/cpython_differences.html#differences-related-to-garbage-collection-strategies">a different way for garbage collection</a>.</li>
<li>You can use the <a href="https://docs.python.org/3/library/multiprocessing.html#shared-ctypes-objects">Shared <code>ctypes</code> Objects</a>.</li>
<li>You can use the <a href="https://docs.python.org/3/library/multiprocessing.shared_memory.html">shared memory</a> for Python &gt;= 3.8.</li>
<li>You can use the <a href="https://docs.python.org/3/library/mmap.html">mmap</a> to <a href="https://pythonspeed.com/articles/reduce-memory-array-copies/">reduce memory usage of array copies</a>.</li>
</ul>
<h2 id="suggestions">Suggestions</h2>
<ul>
<li>Try to use Go, Rust, or C++ to do concurrency computing.</li>
<li>Use <em>spawn</em> instead of <em>fork</em>.</li>
<li>Be careful about the garbage collection behavior.</li>
</ul>

    </div>

    <div class="post-before-footer">
        
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License"
        style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work is
licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons
    Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

    </div>

    <div class="post-footer">
        
            
            <div class="post-nav">
                
                <a class="previous" href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;blogs&#x2F;cicd-for-data-science&#x2F;">â€¹ CI&#x2F;CD for data science</a>
                
                
                <a class="next" href="https:&#x2F;&#x2F;blog.mapotofu.org&#x2F;blogs&#x2F;pycon-china-2022-envd&#x2F;">PyChon China 2022 - envd â€º</a>
                
                
                
            </div>
            
        
    </div>
</article>

            </div>
        </main>

        
        
    </div>

    
    <script src="https://blog.mapotofu.org/script.js"></script>
    
</body>

</html>